# 01_繰り返し期待値の法則（Law of Iterated Expectations）

## 📅 学習時間：1時間
## 🎯 この法則だけで：3-4点獲得
## 💪 難易度：★☆☆☆☆（超基礎から）

---

## 📝 問題1：ウォームアップ（難易度：★☆☆☆☆）

### **問題**
次の等式は正しいか？
```
E(Y) = E{E(Y|X)}
```

**選択肢：**
- A. 正しい
- B. 間違っている
- C. 場合による

---

### **答え：A. 正しい**

---

## 🎓 問題1の詳細解説

### **なぜこれが成り立つのか？**

#### **直感的な理解：クラスの平均点**

**状況：**
- 3つのクラス（A, B, C）がある
- 各クラスの人数と平均点が異なる

**全体の平均を求める2つの方法：**

**方法1：全員の点数を直接平均する**
```
全体の平均 = (全員の点数の合計) / (全員の人数)
```
→ これが **E(Y)**

**方法2：まずクラスごとの平均を出して、それを人数で重み付けして平均する**
```
全体の平均 = (クラスAの平均 × Aの人数
           + クラスBの平均 × Bの人数
           + クラスCの平均 × Cの人数) / 全員の人数
```
→ これが **E{E(Y|X)}** （Xはクラス）

**→ 当然、どちらも同じ答えになる！**

---

### **具体例で確認**

**設定：**
- クラスA（20人）：平均70点
- クラスB（30人）：平均80点

**方法1：E(Y)**
```
全体の平均 = (70×20 + 80×30) / (20+30)
          = (1400 + 2400) / 50
          = 3800 / 50
          = 76点
```

**方法2：E{E(Y|クラス)}**
```
E(Y|クラス=A) = 70
E(Y|クラス=B) = 80

E{E(Y|クラス)} = 70 × (20/50) + 80 × (30/50)
                = 70 × 0.4 + 80 × 0.6
                = 28 + 48
                = 76点 ✓
```

**→ 一致した！**

---

### **これが「繰り返し期待値の法則」**

**公式：**
```
E(Y) = E{E(Y|X)}
```

**言葉で：**
「Y の期待値は、X で条件付けた Y の条件付き期待値の、さらに期待値に等しい」

**要するに：**
「全体の平均 = グループ別平均の平均」

---

### **数学的な証明（離散版）**

```
E(Y) = Σy y × P(Y=y)

     = Σy y × [Σx P(Y=y|X=x)P(X=x)]    ← 全確率の公式

     = Σx [Σy y × P(Y=y|X=x)] × P(X=x)

     = Σx E(Y|X=x) × P(X=x)

     = E{E(Y|X)} ✓
```

---

### **重要ポイント**

✅ **暗記ではなく理解：**「グループ別平均の平均=全体平均」という当たり前のこと

✅ **試験では：**この公式を使うタイミングを見極めることが重要

---

### **問題1で学んだこと**

- [ ] E(Y) = E{E(Y|X)} が「なぜ」成り立つか説明できる
- [ ] クラスの平均点の例で直感的に理解できる

**✓ なら次の問題へ！**

---

---

## 📝 問題2：定数の扱い（難易度：★★☆☆☆）

### **問題**
次を示せ
```
E(XY|X) = X × E(Y|X)
```

---

## 🎓 問題2の詳細解説

### **核心ポイント**

**条件付き期待値 E(·|X) の中では、X は「定数」として扱える**

---

### **なぜ「定数」なのか？**

**E(·|X) の意味：**
- 「X の値が分かっている」という状況
- X が分かっている = X は「固定された値」
- 固定された値 = 定数

**例：**
- 「身長が170cmの人の体重の平均」を考えるとき
- 170cmという値は「固定されている」= 定数
- だから「170 × E(体重|身長=170)」のように外に出せる

---

### **証明**

```
Step 1: X を条件付けているので、X は定数扱い
E(XY|X) = E(X × Y|X)

Step 2: 定数は期待値の外に出せる
E(X × Y|X) = X × E(Y|X)

∴ E(XY|X) = X × E(Y|X) ✓
```

---

### **練習：次も同じ理屈**

```
E(2Y|X) = 2 × E(Y|X)         （2は定数）
E(X²Y|X) = X² × E(Y|X)       （X²も定数扱い）
E(g(X)Y|X) = g(X) × E(Y|X)   （g(X)も定数扱い）
```

---

### **よくある間違い**

❌ **間違い：E(XY) = X × E(Y)**
```
なぜダメ？
→ X は確率変数なので、条件付けずに外に出せない
```

✅ **正解：E(XY|X) = X × E(Y|X)**
```
なぜ正しい？
→ X で条件付けているので、X は定数扱い
```

---

### **試験での使い方**

**このテクニックは繰り返し期待値の法則の証明で必須！**

例：
```
E(Zu) = E{E(Zu|Z)}
      = E{Z × E(u|Z)}  ← ここで使う！
```

---

### **問題2で学んだこと**

- [ ] E(XY|X) = X × E(Y|X) が「なぜ」成り立つか説明できる
- [ ] 条件付き期待値の中では「条件付けた変数は定数」と理解できる

**✓ なら次の問題へ！**

---

---

## 📝 問題3：独立な変数（難易度：★★☆☆☆）

### **問題**
X と u が独立で、E(u) = 0 のとき
```
E(Xu) = 0
```
を示せ。

---

## 🎓 問題3の詳細解説

### **方針**

**繰り返し期待値の法則を使う**

---

### **証明（ステップバイステップ）**

```
Step 1: 繰り返し期待値の法則を使う
E(Xu) = E{E(Xu|X)}

【なぜこうする？】
→ X で条件付けることで、X を定数として扱えるようにする

---

Step 2: 条件付き期待値の中で X は定数
E(Xu|X) = X × E(u|X)

【なぜこうできる？】
→ 問題2で学んだテクニック

---

Step 3: X と u が独立なので
E(u|X) = E(u)

【なぜ？】
→ 独立 = 「X を知っても u の期待値は変わらない」

---

Step 4: 仮定より E(u) = 0
E(u|X) = 0

---

Step 5: Step 1-4 を組み合わせる
E(Xu) = E{E(Xu|X)}      （Step 1）
      = E{X × E(u|X)}    （Step 2）
      = E{X × 0}         （Step 3, 4）
      = E{0}
      = 0

∴ E(Xu) = 0 ✓
```

---

### **各ステップの役割**

| ステップ | 何をしている | なぜ必要 |
|---------|------------|---------|
| Step 1 | 繰り返し期待値の法則 | X を定数にするため |
| Step 2 | X を外に出す | 期待値を簡単にするため |
| Step 3 | 独立性を使う | 条件付き→無条件に変換 |
| Step 4 | 仮定を使う | E(u)=0 を適用 |
| Step 5 | まとめ | 最終結果 |

---

### **重要な洞察**

**パターン認識：**
1. E(何か) = 0 を示したい
2. → 繰り返し期待値の法則で条件付けする
3. → 与えられた仮定を使えるようにする

**→ このパターンが問題4でも使われる！**

---

### **問題3で学んだこと**

- [ ] 独立性を使った証明ができる
- [ ] 「E(何か)=0を示す」→「繰り返し期待値で条件付け」のパターンを理解

**✓ なら次の問題へ！これが試験そのもの！**

---

---

## 📝 問題4：外生性の証明（難易度：★★★★☆）

**これが【2024年度】HW2 問題2(ii)で必要な証明そのもの！**

### **問題**
E(u|Z) = 0 のとき
```
E(Zu) = 0
```
を示せ。

---

## 🎓 問題4の詳細解説

### **証明（完全版）**

```
【目標】E(Zu) = 0 を示す
【与えられている】E(u|Z) = 0

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Step 1: 繰り返し期待値の法則を適用
E(Zu) = E{E(Zu|Z)}

【解説】
・なぜこうするのか？
  → Z で条件付けることで、与えられた仮定 E(u|Z)=0 が使えるようになる

・どの変数で条件付けるか？
  → 与えられた仮定に出てくる変数（ここでは Z）

・なぜ他の変数ではダメ？
  → E(u|Z)=0 は「Z で条件付けた」ときの仮定だから

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Step 2: 条件付き期待値の中で Z は定数
E(Zu|Z) = Z × E(u|Z)

【解説】
・これは問題2で学んだテクニック
・「Z で条件付けている」= 「Z は分かっている」= 「Z は定数」
・だから Z を外に出せる

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Step 3: 仮定 E(u|Z) = 0 を使う
Z × E(u|Z) = Z × 0 = 0

【解説】
・ようやく与えられた仮定を使う場面！
・これがこの証明の核心部分
・Step 1-2 は全て、この仮定を使うための準備

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Step 4: Step 1-3 を組み合わせる
E(Zu) = E{E(Zu|Z)}      （Step 1）
      = E{Z × E(u|Z)}    （Step 2）
      = E{Z × 0}         （Step 3）
      = E{0}
      = 0

∴ E(Zu) = 0 が示された！ ✓
```

---

### **なぜ各ステップが必要なのか？**

| ステップ | 何をしている | なぜ必要 |
|---------|------------|---------|
| Step 1 | Z で条件付け | 仮定 E(u\|Z)=0 を使えるようにする |
| Step 2 | Z を外に出す | 条件付き期待値を簡単にする |
| Step 3 | 仮定を代入 | 与えられた情報を使う |
| Step 4 | まとめ | 最終結果を導く |

---

### **よくある間違い**

#### **❌ 間違い1：いきなり E(Zu) = Z × E(u) = Z × 0 = 0**

```
なぜダメ？
→ E(Zu) ≠ Z × E(u)
→ Z は確率変数なので、条件付けずに外に出せない
```

#### **❌ 間違い2：E(Zu|Z) = E(Z) × E(u|Z)**

```
なぜダメ？
→ 条件付き期待値の中では Z は「固定された値」
→ だから E(Z) ではなく、Z そのもの
```

#### **✅ 正解：E(Zu|Z) = Z × E(u|Z)**

```
なぜ正しい？
→ Z で条件付けている = Z は定数扱い
→ 定数は外に出せる
```

---

### **試験での配点予想**

**合計：3-4点**

| 記述内容 | 配点 |
|---------|------|
| Step 1を書く：E(Zu) = E{E(Zu\|Z)} | 1点 |
| Step 2を書く：E(Zu\|Z) = Z × E(u\|Z) | 1点 |
| Step 3を書く：仮定 E(u\|Z)=0 を使う | 1-2点 ← 核心 |
| 結論：E(Zu) = 0 | 1点 |

---

### **最低限書くべきこと**

```
E(Zu) = E{E(Zu|Z)}         ← これだけで1点
      = E{Z × E(u|Z)}       ← さらに1点
      = E{Z × 0} = 0        ← ここまでで3-4点
```

**たった3行で3-4点獲得！**

---

### **問題4で学んだこと**

- [ ] E(Zu) = 0 の証明を自力で書ける
- [ ] 「仮定に出てくる変数で条件付ける」という戦略を理解

**✓ なら、この法則は完璧！**

---

---

## ✅ 学習チェックリスト

この4問が解けたら、繰り返し期待値の法則は完璧！

- [ ] 問題1：E(Y) = E{E(Y|X)} が「なぜ」成り立つか説明できる
- [ ] 問題2：E(XY|X) = X × E(Y|X) が「なぜ」成り立つか説明できる
- [ ] 問題3：独立性を使った証明ができる
- [ ] 問題4：E(Zu) = 0 の証明を自力で書ける

**全部✓なら、次のファイル（02_中心極限定理とSlutskyの補題.md）へ！**

---

## 📖 この法則が使われる場所

### **数学補論 p.4 の記載：**
> 「これは最小二乗推定量や操作変数推定量の統計的性質を明らかにする際に**繰り返し使われる重要な性質**である。」

### **期末試験での出題箇所：**
- **問題2(ii)：IV推定量の一致性** ← 3-4点（出題確率98%）
- **問題3：LATE（局所的平均処置効果）** ← さらに10-15点（出題確率95%）

**→ この1つの法則で、合計13-19点分に対応できる！**

---

## 📚 補助学習資料

### **🆕 lecture_20251117.pdf（最優先！）**
- **該当セクション：** Section 3（2SLS = IV の証明）
- **内容：** 繰り返し期待値の法則を実際にどう使うか、構造化された形式でわかりやすく解説
- **推奨：** この練習問題を解く前に lecture_20251117 Section 3 を読むと理解が10倍速くなる！

### **操作変数ノート p.3-5**
- 2SLS推定量の導出（数学補論の法則を実際に使っている例）

### **【2024年度】HW2 問題2(ii)**
- IV推定量の一致性の証明（この練習問題がそのまま使える）

---

**学習時間：1時間**
**習得必須度：★★★★★**
**補助資料：lecture_20251117.pdf Section 3（読んでから始めると効果的！）**
**次のステップ：02_中心極限定理とSlutskyの補題.md**
